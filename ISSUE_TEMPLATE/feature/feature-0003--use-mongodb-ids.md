# ðŸ˜Ž feature/0003--use-mongodb-ids (app-template)

| Issue # | PR #    | Requested by | Implemented by  | Date       | Release # |
| ------- | ------- | ------------ | --------------- | ---------- | --------- |
| `#0003` | `#pppp` | MongoDB      | Timothy McGuire | 2025-11-27 | `a0.0.0`  |

- **Source Branch:** `main`
- **Working Branch:** `feature/0003--use-mongodb-ids`
- **Target Branch:** `develop`
- **Tag:** `a0.0.0`

## Request

Summary description of the requested feature or change. Include links to product requirements, customer tickets, or GitHub issues as applicable.

Change all primary keys from Gravity's "id" to MongoDB ObjectIDs "\_id" across the application.

## Current Behavior (AS-IS)

Describe in detail the current behavior, including screenshots, logs, or relevant references.

Kyle's original implementation uses custom random IDs for all entities.
This requires additional logic to manage ID generation and uniqueness.

- **Current UI, Workflow or Code:**
<p align="left"><img src="./.images/issue-nnnn-before.png" width="720" title="Current behavior" style="border: 0.5px solid lightgray;"></p>

## Requested Behavior (TO-BE)

Describe in detail the desired behavior. Include acceptance criteria, UX/UI mocks, API changes, and any non-functional requirements.

MongoDB recommends using ObjectIDs as primary keys for documents.
Switching to ObjectIDs will simplify the codebase and improve performance.
It will also enhance compatibility with MongoDB features and tools,
and move us to our standard key naming convention, '\_id' and 'parent_id'.

## ID Design Policy (Global)

### 0. Table/Collection Names

- Use **singular** names for all tables/collections.
- Prefix SQL tables with `tbl_` (e.g. `tbl_user`, `tbl_account`).
- MongoDB collections are named without prefixes (e.g. `user`, `account`).

### 1. Primary Keys

- **Canonical name**: Every persisted record has exactly one primary key named `_id`.
- **Table/collection naming**:
  - Tables/collections that hold individual entities use **singular** names.
  - Example: a table of all users is `tbl_user`; each row is one `user` entity.
- **Type by store**:
  - MongoDB: `_id` is a Mongo `ObjectId` in backend memory.
  - SQL (or any other DB): `_id` is still the primary key column name and must be semantically equivalent to a Mongo-style ID (unique, opaque, non-business).
- **Creation**:
  - For Mongo: generated by MongoDB (or standard `ObjectId()` generator), never custom ad hoc logic.
  - For SQL/other stores: generated to preserve the same semantics (opaque, globally unique, non-business).

### 2. Foreign Keys and Relationships

- **Foreign key naming (singular)**:
  - Any reference to another entity uses: `{entity_name}_id`, where `{entity_name}` is singular.
  - Example:
    - Entity table: `tbl_user`
    - Primary key: `_id`
    - Foreign key in another table: `user_id`
- **Join/association tables**:
  - Use one column per referenced entity, each following the same pattern.
  - Example: a `tbl_user_role` table might have `user_id` and `role_id`.
  - If we encounter ambiguous cases (e.g. `user_roles_id`), we will explicitly decide and document them, defaulting to the simple singular rule above.
- **Lists of IDs**:
  - For arrays of references, use `{entity_name}_ids` (plural suffix).
  - Example: `role_ids` as an array of `_id` values referencing `tbl_role`.

### 3. Representation Across Layers

- **Backend (Node/JS)**:
  - `_id` is treated as a Mongo `ObjectId` (or equivalent opaque ID type) in backend code.
- **APIs / JSON / Frontends**:
  - `_id` is serialized as a 24-character hex string (HEX-24).
  - Foreign keys (`{entity}_id`, `{entity}_ids`) are also 24-character hex string(s).
- **Public identifier pattern (external IDs)**:
  - External/public identifiers (API responses, URLs, webhooks, partner integrations) must NOT expose raw internal `_id` values.
  - When an external identifier is needed, define a dedicated public ID field (e.g. `user_ref`, `acct_ref`, or a prefixed code).
  - The mapping from public IDs to internal `_id` remains an internal implementation detail.

### 4. Hard Rules and Prohibitions

- **No alternate primary key names**:
  - Do not use `id`, `userId`, `accountId`, or any variant as the primary key field name.
  - `_id` is the one and only primary key field for every entity.
- **No alternate primary key types**:
  - Do not use numeric auto-increment, UUIDv4, or other schemes as the primary key.
  - Such values may exist as separate, secondary fields (e.g. `account_number`, `uuid`) but never as the canonical primary key or join key.
- **No TypeScript**:
  - This codebase remains JavaScript-only. Do not introduce TypeScript or TS tooling.

### 5. Exposure and Integration

- **Internal vs external IDs**:
  - `_id` and all `{entity}_id` / `{entity}_ids` fields are internal-only implementation details.
  - Public APIs, webhooks, emails, and external-facing logs must use external IDs (e.g. `user_ref`) and never leak raw `_id`.
- **Logging and observability**:
  - Internal logs and metrics may include `_id` values for debugging.
  - If logs are shared externally, they must be scrubbed or reviewed to avoid leaking `_id` values.

### 6. Cross-App Consistency

- **Applies to all apps**:
  - This policy is global across `server`, `admin`, `client`, `portal`, `app`, and any new services or workers.
- **Future enforcement**:
  - All new schemas, migrations, routes, and models must adhere to this policy.
  - Any exception (e.g. due to a legacy or third-party constraint) must be explicitly documented at the point of use.

### 7. External ID Prefix Pattern (Draft)

- **Goal**: Derive short, human-recognizable prefixes for external IDs from the entity/table name.
- **Initial proposal**:
  - Start with the singular entity name (e.g. `user`, `organization`, `invoice`).
  - Take consonants in order until you have 3 characters (padding with vowels if needed).
  - Examples (hypothetical):
    - `user` â†’ `usr_XXXXXXXX`
    - `organization` â†’ `org_XXXXXXXX`
    - `invoice` â†’ `inv_XXXXXXXX`
- **Status**:

  - This is an initial idea and not yet final.
  - Finalization of the external ID prefix scheme will be done before any public APIs, webhooks, or partner integrations are declared stable.

- **Proposed UI, Workflow or Code:**
<p align="left"><img src="./.images/issue-nnnn-after.png" width="720" title="Requested behavior" style="border: 0.5px solid lightgray;"></p>

## Reason for Change

Describe the business reason for the change. Capture measurable benefits, customer impact, compliance obligations, or other drivers.

MongoDB ObjectIDs are optimized for performance and storage efficiency.
Using them will reduce complexity in our codebase and improve maintainability.

## Implementation Plan

Describe the change to code, process, or configuration required to achieve the TO-BE state. Reference affected repos, modules, and components. Include testing strategy and rollout notes.

This change will involve updating the data models, database access layers,
and any related business logic to use MongoDB ObjectIDs. I've already down this once to
Kyle's original implementation, in the original LADDERS code, so this will be a reversion to that approach.

- **Repositories / Modules affected:** `server`, `admin`
- **Dependencies / External systems:** none
- **Database Changes:** Update schemas to use ObjectIDs
- **Testing Plan:** CRUD operations tests, integration tests
- **Risks & Mitigations:** None at this time, not deploying to production yet.
- **Rollout Plan:** Deploy to staging, monitor for issues, then deploy to production.
- **Back-out Plan:** Roll back to previous data model and code versions if issues arise during staging or production deployment.
